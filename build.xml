<?xml version="1.0"?>
<project name="Specify 6.0 Build File" basedir=".">

	<!-- Set up properties containing important project directories -->
	
	<property name="source.root" value="src" />
	
	<property name="compile.src.root" value="compile-src" />
	<property name="compile.dst.root" value="compile-dst" />
	
	<property name="class.root" value="bin" />
	
	<property name="lib.dir" value="libs" />
	<property name="hibernatelib.dir" value="hibernate_libs" />
	<property name="externallib.dir" value="external_libs" />
	<property name="macnative.dir" value="system_dep_libs/mac" />
	<property name="ireport.dir" value="iReportLibs" />
	<property name="system.dep.libs.dir" value="system_dep_libs" />
	<property name="hibernate.properties" value="hibernate.properties" />
	<property name="hibernate.cfg" value="hibernate.cfg.xml" />
	<property name="dir.dest" value="dest" />
	<property name="hibernate.generated.code.destdir" value="generated-src" />

	<property name="data.dir" value="data" />

	<!-- Needed for Packing on the Mac -->
	<property name="packaging" value="packaging" />
	<property name="app.name" value="Specify" />
	<property name="jar.name" value="specify" />
	<property name="dist-mac" value="mac-dist" />


	<!-- Needed for Packing on the Windows -->
	<property name="dist-win" value="win-dist" />

	<!-- Needed for Packing on the Linux -->
	<property name="dist-linux" value="linux-dist" />

	<!-- Set up the class path for compilation and execution -->
	<path id="project.class.path">
		
		<!-- Include jars in the project library directory -->
		<fileset dir="${hibernatelib.dir}">
			<include name="**/*.jar" />
		</fileset>
		
	    <fileset dir="${lib.dir}">
			<include name="**/*.jar" />
		</fileset>

		<fileset dir="${macnative.dir}">
			<include name="**/*.jar" />
		</fileset>
		
		<!-- Include our own classes, of course -->
		<pathelement location="specify.jar"/>
		
	</path>

	<!-- Prepare for Windows and Linux Compile -->
	<target name="dist-prepare" description="Sets up build structures for Non Mac Platforms">
		
		<mkdir dir="${compile.dst.root}" />
		<mkdir dir="${compile.src.root}" />
		
		<copy todir="${compile.src.root}">
			<fileset dir="${source.root}">
				<include name="**/*.properties" />
				<include name="**/*.java" />
			</fileset>
		</copy>
		
	</target>

	<!-- Prepare for Mac Compile -->
	<target name="dist-prepare-mac" description="Sets up build structures for Mac-Dist">
		
		<mkdir dir="${compile.dst.root}" />
		<mkdir dir="${compile.src.root}" />
		
		<copy todir="${compile.src.root}">
			<fileset dir="${source.root}">
				<include name="**/*.properties" />
				<exclude name="**/AttachmentUtils.java" />
				<include name="**/*.java" />
			</fileset>
		</copy>
		
	</target>

	<!-- Compile the java source of the project Windows and Linux -->
	<target name="dist-compile" depends="dist-prepare" description="Compiles all Java classes for Mac-Dist">
		
		<javac srcdir="${compile.src.root}" destdir="${compile.dst.root}" debug="on" optimize="off" deprecation="on">
			<classpath refid="project.class.path" />
		</javac>
		
	</target>
	
	<!-- Compile the java source of the project Mac-->
	<target name="dist-compile-mac" depends="dist-prepare-mac" description="Compiles all Java classes for Mac-Dist">
		
		<javac srcdir="${compile.src.root}" destdir="${compile.dst.root}" debug="on" optimize="off" deprecation="on">
			<classpath refid="project.class.path" />
		</javac>
	</target>
	
	<!-- Jar up compiled classes -->
	<target name="dist-jar" depends="">
		
		<jar destfile="${jar.name}.jar" basedir="${class.root}" />

	</target>

	<!-- Jar up compiled classes -->
	<target name="dist-jar-mac" depends="">
		
		<jar destfile="${jar.name}.jar" basedir="${class.root}" />

	</target>

	<!-- Jar Clean Up -->
	<target name="clean-jar">
		<delete file="${jar.name}.jar" />
	</target>
	

	<!-- *************************************************************
	     Mac Distribution for the Builder
	     ************************************************************* -->
	<target name="dist-mac-bld" depends="">
		
		<property name="appdir" value="${dist-mac}/SpecifyBuilder.app" />
		<property name="derby.data.path" value="${dist-mac}" />

		<mkdir dir="${dist-mac}" />
		<mkdir dir="${appdir}" />
		<mkdir dir="${appdir}/Contents" />
		<mkdir dir="${appdir}/Contents/MacOS" />
		<mkdir dir="${appdir}/Contents/Resources" />
		<mkdir dir="${appdir}/Contents/Resources/Java" />
		<mkdir dir="${appdir}/Contents/Resources/Java/src" />
		<mkdir dir="${appdir}/Contents/Resources/Java/config" />
		<mkdir dir="${appdir}/Contents/Resources/Java/system_dep_libs" />
		<mkdir dir="${appdir}/Contents/Resources/Java/system_dep_libs/mac" />

		<!-- Copy Application Stub Compile the java source of the project -->
		<copy file="${packaging}/JavaApplicationStub" todir="${appdir}/Contents/MacOS" />
		<exec command="chmod 755 ${appdir}/Contents/MacOS/JavaApplicationStub" />

		<!-- Copy info list -->
		<copy file="${packaging}/builder/Info.plist" todir="${appdir}/Contents" />

		<!-- Copy PkgInfo -->
		<copy file="${packaging}/builder/PkgInfo" todir="${appdir}/Contents" />

		<!-- Copy hibernate.cfg.xml -->
		<copy file="src/hibernate.cfg.xml" todir="${appdir}/Contents/Resources/Java/src" />

		<!-- Copy config demo_files -->
		<copy todir="${appdir}/Contents/Resources/Java/demo_files">
			<fileset dir="demo_files">
				<include name="**/*.*" />
			</fileset>
		</copy>
		
		<!-- Copy config dir -->
		<copy todir="${appdir}/Contents/Resources/Java/config">
			<fileset dir="config">
				<include name="**/*.xml" />
			</fileset>
		</copy>
		
		<!-- Copy the main app jar -->
		<copy file="${jar.name}.jar" todir="${appdir}/Contents/Resources/Java" />

		<!-- Copy the build.xml -->
		<copy file="build.xml" todir="${appdir}/Contents/Resources/Java" />

		<!-- Copy Icons -->
		<copy file="${packaging}/builder/specifybldr.icns" todir="${appdir}/Contents/Resources" />

		<copy todir="${appdir}/Contents/Resources/Java/libs">
			<fileset dir="libs">
				<include name="*.jar" />
			</fileset>
		</copy>
		
		<copy todir="${appdir}/Contents/Resources/Java/hibernate_libs">
			<fileset dir="${hibernatelib.dir}">
				<include name="*.jar" />
			</fileset>
		</copy>
		
		<copy todir="${appdir}/Contents/Resources/Java/external_libs">
			<fileset dir="external_libs">
				<include name="*.jar" />
			</fileset>
		</copy>
		
		<copy todir="${appdir}/Contents/Resources/Java/system_dep_libs">
			<fileset dir="system_dep_libs">
				<include name="*.jar" />
			</fileset>
		</copy>

		<copy todir="${appdir}/Contents/Resources/Java/system_dep_libs/mac">
			<fileset dir="system_dep_libs/mac">
				<include name="*.jar" />
			</fileset>
		</copy>

		<copy todir="${appdir}/Contents/Resources/Java">
			<fileset dir="${macnative.dir}">
				<include name="*.jar" />
			</fileset>
		</copy>

		<!-- Tell OS the dir is an App -->
		<exec command="/Developer/Tools/SetFile -a B ${appdir}" />

	</target>

	<!-- *************************************************************
	    Mac Distribution
	    ************************************************************* -->
	<target name="dist-mac" depends="">
		
		<property name="appdir" value="${dist-mac}/${app.name}.app" />
		<property name="derby.data.path" value="${dist-mac}" />
		
		<antcall target="clean-jar"/>
		<antcall target="dist-jar-mac"/>
		<antcall target="dist-mac-clean"/>
		
		
		<antcall target="build-empty-derby-db"/>
		
		
		<mkdir dir="${dist-mac}" />
		<mkdir dir="${appdir}" />
		<mkdir dir="${appdir}/Contents" />
		<mkdir dir="${appdir}/Contents/MacOS" />
		<mkdir dir="${appdir}/Contents/Resources" />
		<mkdir dir="${appdir}/Contents/Resources/Java" />
		<mkdir dir="${appdir}/Contents/Resources/Java/config" />

		<!-- Copy Application Stub Compile the java source of the project -->
		<copy file="${packaging}/JavaApplicationStub" todir="${appdir}/Contents/MacOS" />
		<exec command="chmod 755 ${appdir}/Contents/MacOS/JavaApplicationStub" />

		<!-- Copy info list -->
		<copy file="${packaging}/Info.plist" todir="${appdir}/Contents" />

		<!-- Copy PkgInfo -->
		<copy file="${packaging}/PkgInfo" todir="${appdir}/Contents" />

		<!-- Copy config dir -->
		<copy todir="${appdir}/Contents/Resources/Java/config">
			<fileset dir="config">
				<exclude name="**/*.svn" />
			</fileset>
		</copy>
		
		<!-- Copy the main app jar -->
		<copy file="${jar.name}.jar" todir="${appdir}/Contents/Resources/Java" />

		<!-- Copy Icons -->
		<copy file="${packaging}/specify.icns" todir="${appdir}/Contents/Resources" />

		<copy todir="${appdir}/Contents/Resources/Java">
			<fileset dir="libs">
				<include name="*.jar" />
			</fileset>
			<fileset dir="${hibernatelib.dir}">
				<include name="*.jar" />
			</fileset>
			<fileset dir="${ireport.dir}">
				<include name="iReport.jar" />
			</fileset>
			<fileset dir="${macnative.dir}">
				<include name="*.jar" />
			</fileset>
		</copy>

		<!-- Tell OS the dir is an App -->
		<exec command="/Developer/Tools/SetFile -a B ${appdir}" />
		

		<!-- Copy Help -->
		<copy todir="${appdir}/Contents/Resources/Java/help">
			<fileset dir="help">
				<exclude name="**/.svn" />
			</fileset>
		</copy>
		
		
		<!-- Testing Alt Help 
		<property name="alt.help.img.dir" value="AltHelpImages/Windows"/>
		<antcall target="copy-alt-help-images"/> -->

		<!-- Demo Files -->
		<copy file="demo_files/workbench/FishCollectingTrip.csv" todir="${dist-mac}/examples" />
		<copy file="demo_files/workbench/JohsonCountyTrip.csv" todir="${dist-mac}/examples" />
	    <copy file="demo_files/workbench/SaipanTrip.xls" todir="${dist-mac}/examples" />

	</target>

	<target name="dist-mac-wb" depends="">
		
		<property name="appdir" value="${dist-mac}/${app.name}.app" />
		<property name="derby.data.path" value="${dist-mac}/DerbyDatabases" />
		
		<antcall target="clean-jar"/>
		<antcall target="dist-jar-mac"/>
		<antcall target="dist-mac-clean"/>
		
		<antcall target="build-empty-derby-db"/>
		
		<mkdir dir="${dist-mac}" />
		<mkdir dir="${appdir}" />
		<mkdir dir="${appdir}/Contents" />
		<mkdir dir="${appdir}/Contents/MacOS" />
		<mkdir dir="${appdir}/Contents/Resources" />
		<mkdir dir="${appdir}/Contents/Resources/Java" />
		<mkdir dir="${appdir}/Contents/Resources/Java/config" />

		<!-- Copy Application Stub Compile the java source of the project -->
		<copy file="${packaging}/JavaApplicationStub" todir="${appdir}/Contents/MacOS" />
		<exec command="chmod 755 ${appdir}/Contents/MacOS/JavaApplicationStub" />

		<!-- Copy info list -->
		<copy file="${packaging}/WBInfo.plist" todir="${appdir}/Contents" />
		<rename src="${appdir}/Contents/WBInfo.plist" dest="${appdir}/Contents/Info.plist"/>
		
		<!-- Copy PkgInfo -->
		<copy file="${packaging}/PkgInfo" todir="${appdir}/Contents" />

		<!-- Copy config dir -->
		<copy todir="${appdir}/Contents/Resources/Java/config">
			<fileset dir="config">
				<exclude name="**/*.svn" />
			</fileset>
		</copy>
		
		<!-- Copy the main app jar -->
		<copy file="${jar.name}.jar" todir="${appdir}/Contents/Resources/Java" />

		<!-- Copy Icons -->
		<copy file="${packaging}/specify.icns" todir="${appdir}/Contents/Resources" />

		<copy todir="${appdir}/Contents/Resources/Java">
			<fileset dir="libs">
				<include name="*.jar" />
			</fileset>
			<fileset dir="${hibernatelib.dir}">
				<include name="*.jar" />
			</fileset>
			<fileset dir="${ireport.dir}">
				<include name="iReport.jar" />
			</fileset>
			<fileset dir="${macnative.dir}">
				<include name="*.jar" />
			</fileset>
		</copy>

		<!-- Tell OS the dir is an App -->
		<exec command="/Developer/Tools/SetFile -a B ${appdir}" />
		

		<!-- Copy Help -->
		<copy todir="${appdir}/Contents/Resources/Java/help">
			<fileset dir="help">
				<exclude name="**/.svn" />
			</fileset>
		</copy>

		<!-- Demo Files -->
		<copy file="demo_files/workbench/FishCollectingTrip.csv" todir="${dist-mac}/examples" />
		<copy file="demo_files/workbench/JohsonCountyTrip.csv" todir="${dist-mac}/examples" />
	    <copy file="demo_files/workbench/SaipanTrip.xls" todir="${dist-mac}/examples" />

	</target>

		
	<!-- *************************************************************
	     Build Empty Derby DB
	     ************************************************************* -->
	<target name="build-empty-derby-db">
		<!--
		<property name="current.classpath" refid="project.class.path"/>
		<echo level="info">
		   Classpath is :
		      ${current.classpath}
		   </echo>
		-->
		
		<java classname="edu.ku.brc.specify.tests.BuildSampleDatabase" fork="true">
		    <classpath refid="project.class.path" />
			<arg value="build_empty"/>
			<arg value="${derby.data.path}"/>
		</java>
	</target>
		
	<!-- *************************************************************
	     Common files between Windows and Linux
	     ************************************************************* -->
	<target name="basic-non-mac-dist">

		<!-- Copy config dir -->
		<copy todir="${appdir}/config">
			<fileset dir="config">
				<exclude name="**/.svn" />
				<exclude name="**/.csv" />
			</fileset>
		</copy>
		
		<!-- Copy the main app jar -->
		<copy file="${jar.name}.jar" todir="${appdir}/libs" />

		<copy todir="${appdir}/libs">
			<fileset dir="libs">
				<include name="*.jar" />
			</fileset>
			<fileset dir="${hibernatelib.dir}">
				<include name="*.jar" />
			</fileset>
			<fileset dir="${ireport.dir}">
				<include name="iReport.jar" />
			</fileset>
			<fileset dir="${system.dep.libs.dir}">
				<include name="*.jar" />
			</fileset>
		</copy>

		<!-- Copy Help -->
		<copy todir="${appdir}/help">
			<fileset dir="help">
				<exclude name="**/.svn" />
			</fileset>
		</copy>

	</target>

	<!-- *************************************************************
	     Windows Distribution
	     ************************************************************* -->
	<target name="dist-win">
		
		<property name="appdir" value="${dist-win}/Specify" />
		<property name="derby.data.path" value="${dist-win}/DerbyDatabases" />
		
		<antcall target="clean-jar"/>
		<antcall target="dist-win-clean"/>
		<antcall target="dist-jar"/>
		
		<mkdir dir="${dist-win}" />
		<mkdir dir="${appdir}/libs" />
		<mkdir dir="${dist-win}/examples" />
		
		<antcall target="build-empty-derby-db"/>
		<antcall target="basic-non-mac-dist"/>
		
		<!-- Copy Alt Help Image Files -->
		<property name="alt.help.img.dir" value="AltHelpImages/Windows"/>
	    <antcall target="copy-alt-help-images"/>
		
		<!-- Demo Files -->
		<copy file="demo_files/workbench/FishCollectingTrip.csv" todir="${dist-win}/examples" />
		<copy file="demo_files/workbench/JohsonCountyTrip.csv" todir="${dist-win}/examples" />
	    <copy file="demo_files/workbench/SaipanTrip.xls" todir="${dist-win}/examples" />

	</target>

	<target name="dist-win-jar">
		
		<property name="appdir" value="${dist-win}/Specify" />
		<property name="derby.data.path" value="${dist-win}/DerbyDatabases" />
		
		<antcall target="clean-jar"/>
		<antcall target="dist-jar"/>
		
		<copy file="${jar.name}.jar" todir="${appdir}/libs" />
		
	</target>

	<!-- *************************************************************
	     Linux Distribution
	     ************************************************************* -->
	<target name="dist-linux">
		
		<property name="appdir" value="${dist-linux}/Specify" />
		<property name="derby.data.path" value="${dist-linux}/DerbyDatabases" />
		
		<antcall target="clean-jar"/>
		
		<antcall target="dist-linux-clean"/>
		
	    <antcall target="dist-jar"/>
		
		
		<mkdir dir="${dist-linux}" />
		<mkdir dir="${appdir}/libs" />

		
		<antcall target="build-empty-derby-db"/>
		
		<antcall target="basic-non-mac-dist"/>
		
		<!-- Copy Alt Help Image Files -->
		<property name="alt.help.img.dir" value="AltHelpImages/Windows"/>
	    <antcall target="copy-alt-help-images"/>
				
		
		<!-- Copy info list -->
		<copy file="${packaging}/linux/specify.sh" todir="${dist-linux}/." />
		<chmod file="${dist-linux}/specify.sh" perm="u+rx"/>
		
		<!-- Demo Files -->
		<copy file="demo_files/workbench/FishCollectingTrip.csv" todir="${dist-linux}/examples" />
		<copy file="demo_files/workbench/JohsonCountyTrip.csv" todir="${dist-linux}/examples" />
	    <copy file="demo_files/workbench/SaipanTrip.xls" todir="${dist-linux}/examples" />
		
	</target>
	
	<!--*************************************************************
	     Copy Alternate Help Images
	    ************************************************************* -->
	<target name="copy-alt-help-images">
		
		<!-- <property name="appdir" value="${dist-mac}/${app.name}.app" />
		<property name="alt.help.img.dir" value="AltHelpImages/Windows"/>
		<copy todir="${appdir}/Contents/Resources/Java/help/SpecifyHelp/images" flatten="true" overwrite="true"> -->
		<copy todir="${appdir}/help/SpecifyHelp/images" flatten="true" overwrite="true">
			<fileset dir="${alt.help.img.dir}">
				<exclude name="**/.svn" />
				<include name="**/*.png" />
			</fileset>
		</copy>
		
	</target>



	<!--*************************************************************
	     Clean Distributions
	    ************************************************************* -->
	<target name="dist-mac-clean">
		<delete dir="${dist-mac}"/>
    </target>
	
	<target name="dist-win-clean">
		<delete dir="${dist-win}"/>
    </target>
	
	<target name="dist-linux-clean">
		<delete dir="${dist-linux}"/>
    </target>
	
</project>
